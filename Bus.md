# 总线

## 总线概述

* 作用：连接各个部件的信息传输线，为各个部件共享的传输介质
* 信息传送方式：
  * 串行：传输的数据单位串行传送，适用于长距离传输
  * 并行：传输的数据多位并行传送，适用于短距离传输
* 总线结构分类
  * 单总线结构：CPU、主存、I/O设备连接于同一条总线[图1]
  * 面向CPU的双总线结构：CPU与I/O设备通过I/O总线连接，CPU与主存通过M总线连接，主存不与I/O总线连接[图2]
  * 以存储器为中心的双总线结构：CPU与主存通过存储总线连接，同时CPU、主存、I/O设备都连接在系统总线上[图3]
* 总线分类
  * 片内总线：芯片内部的总线
  * 系统总线：计算机各部件之间的信息传输线
    * 数据总线：双向，与机器字长、存储字长相关
    * 地址总线；单向，与存储地址、I/O地址有关
    * 控制总线：有出（存储器读、写，总线允许，中断确认），有入（中断请求，总线请求）
  * 通信总线：用于计算机系统之间或计算机系统与其他系统之间的通信
    * 传输方式：
      * 串行通信总线
      * 并行通信总线
* 总线特性
  * 机械特性：涉及尺寸、形状、管脚数、排列顺序
  * 电气特性：传输方向、有效的电平范围
  * 功能特性：每根传输线的功能（地址、数据、控制）
  * 时间特性：信号的时序关系
* 总线的性能指标：
  * 总线宽度：数据线的根数
  * 标准传输率：每秒传输的<font color=#FF0033>最大</font>字节数(MBps)
  * 时钟同步/异步
  * 总线复用：地址线与数据线复用(减少芯片的管脚数，减少封装体系)
  * 信号线数：地址线、数据线和控制线的总和
  * 总线控制方式：突发、自动、仲裁、逻辑、计数
  * 其他指标：负载能力(I/O设备挂载的能力)
* 总线的标准
  * 作用：使得不同内部结构的部件在统一的规范下能够协调运行，集成各个部件
  * 涉及的指标：数据线宽度、总线时钟、带宽
* 总线结构
  * 单总线结构：如图1，总线会称为系统的瓶颈
  * 双总线结构：通道含有控制器、指令系统，能够执行简单指令，程序由操作系统编写[图4]
  * 三总线结构1：I/O总线、主存总线(以CPU为核心)、DMA总线(高速外部设备直接访问内存)，提高外设与内存的信息交换速度[图5]
  * 三总线结构2：局部总线、系统总线、扩展总线，为了缓解CPU与内存速度不一致问题[图6]
  * 四总线结构：局部总线、系统总线、扩展总线、高速总线，为了适应不同设备的信息交换速度(解决三总线结构2的扩展总线存在的问题)[图7]

## 总线控制

* 总线判优控制
  * 基本概念
    * 主设备（模块）:对总线有控制权
    * 从设备（模块）：响应从主设备发来的总线命令
    * 判优控制：
      * 集中式：
        * 链式查询
        * 计数器定时查询
        * 独立请求方式
      * 分布式
  * 链式查询方式  
    * 实现:每个部件在共享的BR(总线请求)线上在总线不忙的情况下向总线控制部件发送总线请求,总线控制部件沿着BG(总线同意)线逐个向线路上的发送请求的部件发出同意请求信号，部件在获得总线控制权时总线BS标记为忙[图7]
    * 缺点：优先权固定，部分部件可能一直无法获得总线使用权；对电路故障敏感
    * 优点：部件实现简单；可扩展性好
  * 计数器定时查询：
    * 查询实现：总线部件中含有计数器，在总线不忙的情况下，通过计数器随机产生的设备地址，查询该地址的部件是否有总线请求，若有则分配总线的使用权[图8]
    * 优点：优先级确定灵活
    * 缺点：相对于链式查询方式，增加了设备地址线，数据线增多
  * 独立请求方式
    * 实现：每个部件都有独立的请求线和同意线，总线控制部件内部设置排队器，控制部件根据请求的部件的优先级排队分配总线使用权[图9]
    * 缺点：n个部件需要2条线实现
    * 优点：优先级设置灵活（通过优先级排序）
* 总线通信控制
  * 目的：解决通信双方协调配合问题
  * 总线传输周期：
    * 申请分配：主模块申请，总线仲裁决定
    * 寻址阶段：主模块向从模块给出地址和命令
    * 传输阶段：主模块和从模块交换数据
    * 结束阶段：主模块撤销有关信息
  * 总线通信的方式：
    * 同步通信：由统一时标控制数据传送
    * 异步通信：采用应答方式，没有公共时钟标准
    * 半同步通信：同步、异步结合
    * 分离式通信
  * 同步通信：
    * 方式：传输周期的每个阶段由统一的时标控制，规定了每个周期需要完成的操作(所有的动作仍然具有先后顺序，所谓的同步是每个动作的起始/结束由时钟沿上升/下降控制)
    * 缺点：性能受限，时钟周期取决于最慢的操作花费的时间
  * 异步通信：(增加请求线、应答线)
    * 分类：依据主设备发出的请求信号、从设备发出的应答信号的处理方式
      * 不互锁：
        * 实现：主设备在不考虑从设备是否接受到请求信号的情况下自行撤销请求信号，从设备在接受到请求信号后不作回应，不返回请求信号
        * 影响：无法实现可靠的通信
      * 半互锁：
        * 实现：从设备在接收到请求信号后返回应答信号但是不会考虑主设备再次返回的信号(即不考虑主设备是否接收到应答信号)就会撤销应答信号，主设备在接收到应答信号才撤销信号
        * 影响：主设备可能一直无法撤销请求信号
      * 全互锁：
        * 实现：从设备对主设备返回应答信号，并接收到主设备再次发出的信号后才撤销信号
        * 影响：能够实现可靠通信
  * 分离式通信：
    * 实现：主模块在传送地址、发送命令后撤销总线占用请求(即在使用完总线后放弃使用权)，从模块在数据准备完成后申请总线，发出地址、命令，传输数据
    * 特点：
      * 所有模块都有权力申请占用总线
      * 采用同步方式通信，不等对方回答
      * 各模块准备数据时不占用总线
      * 总线被占用时，无空闲
    * 优点：充分利用总线带宽
